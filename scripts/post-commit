#!/usr/bin/env node
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { execSync } from 'child_process';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const projectRoot = path.join(__dirname, '..');

const tmpFile = path.join(projectRoot, '.git', '.version-bump-type');
if (!fs.existsSync(tmpFile)) process.exit(0);

const bumpType = fs.readFileSync(tmpFile, 'utf8').trim();
fs.unlinkSync(tmpFile);

const pkgPath = path.join(projectRoot, 'package.json');
const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));

const [major, minor, patch] = pkg.version.split('.').map(Number);
let newVersion;
if (bumpType === 'major') newVersion = `${major + 1}.0.0`;
else if (bumpType === 'minor') newVersion = `${major}.${minor + 1}.0`;
else newVersion = `${major}.${minor}.${patch + 1}`;

pkg.version = newVersion;
fs.writeFileSync(pkgPath, JSON.stringify(pkg, null, 2) + '\n');

execSync('git add package.json', { stdio: 'inherit' });
execSync('git commit --amend --no-edit --no-verify', { stdio: 'inherit' });

console.log(`âœ… Version bumped to ${newVersion} and included in this commit.`);
