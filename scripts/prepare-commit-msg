#!/usr/bin/env node
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { execSync } from 'child_process';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const projectRoot = path.join(__dirname, '..');

// Get the commit message file path
const commitMsgFile = process.argv[2];

// Read the raw commit message
let commitMsg = fs.readFileSync(commitMsgFile, 'utf8');

// Check for version bump flag
const versionMatch = commitMsg.match(/--(major|minor|patch)/i);
if (!versionMatch) process.exit(0);

const bumpType = versionMatch[1].toLowerCase();

// --- Bump version in package.json ---
const pkgPath = path.join(projectRoot, 'package.json');
const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));

const [major, minor, patch] = pkg.version.split('.').map(Number);
let newVersion;
if (bumpType === 'major') newVersion = `${major + 1}.0.0`;
else if (bumpType === 'minor') newVersion = `${major}.${minor + 1}.0`;
else newVersion = `${major}.${minor}.${patch + 1}`;

pkg.version = newVersion;
fs.writeFileSync(pkgPath, JSON.stringify(pkg, null, 2) + '\n');

// Stage the updated package.json
execSync('git add package.json', { stdio: 'inherit' });

// Clean the flag from the commit message
const cleanMsg = commitMsg.replace(/--(major|minor|patch)/i, '').trim();
fs.writeFileSync(commitMsgFile, cleanMsg + '\n');

// Amend the in-progress commit to include package.json
execSync('git commit --amend --no-edit --no-verify', { stdio: 'inherit' });

console.log(`‚úÖ Version bumped to ${newVersion} and included in this commit.`);
console.log(`üìù Commit message: "${cleanMsg}"`);