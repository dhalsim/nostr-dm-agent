#!/usr/bin/env node
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { execSync } from 'child_process';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const projectRoot = path.join(__dirname, '..');

const commitMsgFile = process.argv[2];
let commitMsg = fs.readFileSync(commitMsgFile, 'utf8');

const versionMatch = commitMsg.match(/--(major|minor|patch)/i);
if (!versionMatch) process.exit(0);

const bumpType = versionMatch[1].toLowerCase();
const pkgPath = path.join(projectRoot, 'package.json');
const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));

// Bump version
const [major, minor, patch] = pkg.version.split('.').map(Number);
let newVersion;
if (bumpType === 'major') newVersion = `${major+1}.0.0`;
else if (bumpType === 'minor') newVersion = `${major}.${minor+1}.0`;
else newVersion = `${major}.${minor}.${patch+1}`;

pkg.version = newVersion;
fs.writeFileSync(pkgPath, JSON.stringify(pkg, null, 2) + '\n');

// Stage the updated file and amend the commit
execSync('git add package.json', { stdio: 'inherit' });
execSync('git commit --amend --no-edit', { stdio: 'inherit' });

// Clean the flag from the commit message (optional)
commitMsg = commitMsg.replace(/--(major|minor|patch)/i, '').trim();
fs.writeFileSync(commitMsgFile, commitMsg + '\n');

console.log(`âœ… Version bumped to ${newVersion} and amended into the commit`);
